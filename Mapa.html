
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Biocombustibles por Estado</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #efefef;
            text-align: center;
        }
        #map {
            height: 500px;
            margin: 20px auto;
            width: 90%;
        }
        canvas {
            margin: 20px auto;
        }
        .filters {
            margin: 10px;
        }
    </style>
</head>
<body>
    <h2>Mapa de Biocombustibles por Estado</h2>
    <div class="filters">
        Tipo: 
        <select id="tipoSelect">
            <option value="Todos">Todos</option>
        </select>
        Estado: 
        <select id="estadoSelect">
            <option value="Todos">Todos</option>
        </select>
    </div>
    <div id="map"></div>
    <h3>Distribución por Tipo de Bioenergético</h3>
    <canvas id="tipoChart" width="400" height="200"></canvas>
    <h3>Permisos por Estado</h3>
    <canvas id="estadoChart" width="400" height="200"></canvas>

    <script>
        let map = L.map('map', {
            minZoom: 4,
            maxBounds: [[14, -120], [34, -85]]
        }).setView([23.5, -102], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let tipoSelect = document.getElementById("tipoSelect");
        let estadoSelect = document.getElementById("estadoSelect");
        let tipoChart, estadoChart;
        let markers = [];

        fetch("puntos.json")
            .then(response => response.json())
            .then(data => {
                let tipos = [...new Set(data.map(p => p.tipo))];
                let estados = [...new Set(data.map(p => p.estado))];

                tipos.forEach(t => {
                    let opt = document.createElement("option");
                    opt.value = t;
                    opt.text = t;
                    tipoSelect.appendChild(opt);
                });

                estados.forEach(e => {
                    let opt = document.createElement("option");
                    opt.value = e;
                    opt.text = e;
                    estadoSelect.appendChild(opt);
                });

                function updateMap() {
                    markers.forEach(m => map.removeLayer(m));
                    markers = [];

                    let tipo = tipoSelect.value;
                    let estado = estadoSelect.value;

                    let filtered = data.filter(p =>
                        (tipo === "Todos" || p.tipo === tipo) &&
                        (estado === "Todos" || p.estado === estado)
                    );

                    let tipoCounts = {};
                    let estadoCounts = {};

                    filtered.forEach(p => {
                        let marker = L.marker([p.lat, p.lng], {
                            icon: L.icon({
                                iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
                                iconSize: [20, 20],
                                iconAnchor: [10, 20],
                                popupAnchor: [0, -20]
                            })
                        }).addTo(map)
                        .bindPopup(`<b>${p.nombre}</b><br>${p.tipo}<br>${p.estado}`);
                        markers.push(marker);

                        tipoCounts[p.tipo] = (tipoCounts[p.tipo] || 0) + 1;
                        estadoCounts[p.estado] = (estadoCounts[p.estado] || 0) + 1;
                    });

                    // Chart por tipo
                    let tipoLabels = Object.keys(tipoCounts);
                    let tipoData = Object.values(tipoCounts);

                    if (tipoChart) tipoChart.destroy();
                    tipoChart = new Chart(document.getElementById("tipoChart"), {
                        type: "bar",
                        data: {
                            labels: tipoLabels,
                            datasets: [{
                                label: "Cantidad",
                                backgroundColor: "#4a90e2",
                                data: tipoData
                            }]
                        }
                    });

                    // Chart por estado
                    let estadoLabels = Object.keys(estadoCounts);
                    let estadoData = Object.values(estadoCounts);

                    if (estadoChart) estadoChart.destroy();
                    estadoChart = new Chart(document.getElementById("estadoChart"), {
                        type: "bar",
                        data: {
                            labels: estadoLabels,
                            datasets: [{
                                label: "Cantidad",
                                backgroundColor: "#7ed957",
                                data: estadoData
                            }]
                        }
                    });
                }

                tipoSelect.addEventListener("change", updateMap);
                estadoSelect.addEventListener("change", updateMap);
                updateMap();
            });
    </script>
</body>
</html>
