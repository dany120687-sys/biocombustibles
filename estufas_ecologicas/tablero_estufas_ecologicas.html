<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Programa Nacional de Estufas Eficientes de Leña para el Bienestar · DGER</title>

  <!-- Tipografía -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- jQuery + DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --guinda:#9F2241; --guinda-osc:#691C32; --azul:#10312B;
      --dorado:#BC955C; --beige:#DDC9A3; --gris-700:#6F7271; --gris-500:#98989A;
      --verde:#8FAB85; --fondo:#ffffff; --panel:#f6f7f8; --borde:#eaecf0; --texto:#1b1f29;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Noto Sans',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:11pt;line-height:1.35;color:var(--texto);background:var(--fondo)}
    header{background:var(--azul);color:#fff;padding:18px 24px;display:flex;gap:16px;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,.08);position:relative}
    .brand{font-size:22px;font-weight:800}
    .brand small{display:block;font-weight:600;opacity:.9}
    .logo-strip{position:absolute;right:16px;top:10px;display:flex;gap:12px;align-items:center;background:#fff;padding:8px 12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.12);max-width:60vw}
    .logo-strip img{height:28px;width:auto;display:block;background:#fff;padding:2px 4px;border-radius:6px}
    @media (max-width:900px){.logo-strip{display:none}}

    .container{max-width:1200px;margin:24px auto;padding:0 16px}

    /* Filtros */
    .filters{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:12px;margin-bottom:18px}
    .filters label{font-size:10pt;opacity:.8}
    .filters select{width:100%;padding:10px 12px;border:1px solid var(--borde);border-radius:12px;background:#fff;outline:none}
    .filters select:focus{border-color:var(--guinda);box-shadow:0 0 0 3px #9f22412a}

    /* KPIs */
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:0 0 18px}
    .kpi{background:var(--panel);border:1px solid var(--borde);border-radius:14px;padding:16px}
    .kpi .label{font-size:10pt;letter-spacing:.3px;color:var(--gris-700)}
    .kpi .value{font-size:24px;font-weight:800;color:var(--azul)}

    /* Layout y tarjetas */
    .layout{display:grid;grid-template-columns:1.15fr .85fr;gap:16px}
    .card{background:var(--panel);border:1px solid var(--borde);border-radius:16px;padding:16px}
    h2{margin:0 0 10px;font-size:16pt;color:var(--guinda-osc)}
    #map{height:360px;border-radius:12px;overflow:hidden;border:1px solid var(--borde);background:#fff}

    /* Galería */
    .gallery{margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .thumb{display:block;background:#fff;border:1px solid var(--borde);border-radius:12px;padding:10px}
    .thumb img{width:100%;height:120px;object-fit:cover;border-radius:8px;cursor:zoom-in}
    .thumb figcaption{font-size:10pt;margin-top:6px;color:var(--gris-700)}

    /* DataTables */
    table.dataTable thead th{background:#fff;color:var(--azul)}
    table.dataTable tbody tr:hover{background:#fafafa}

    footer{margin:28px 0 48px;text-align:center;font-size:10pt;color:var(--gris-700)}

    @media (max-width:1000px){
      .filters{grid-template-columns:repeat(2,1fr)}
      .kpis{grid-template-columns:repeat(2,1fr)}
      .layout{grid-template-columns:1fr}
      .gallery{grid-template-columns:1fr 1fr}
    }

    .leaflet-container{z-index:0}.info.legend{z-index:400}

    /* Lightbox */
    .lightbox{display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,.85); align-items:center; justify-content:center; padding:24px;}
    .lightbox.open{display:flex}
    .lightbox img{max-width:92vw; max-height:86vh; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .lightbox .close{position:absolute; top:16px; right:20px; color:#fff; font-size:32px; line-height:1; cursor:pointer; background:transparent; border:0; padding:6px 10px;}
    .lightbox .close:focus{ outline:2px solid #fff3; outline-offset:2px; border-radius:6px; }
  </style>
</head>
<body>
<header>
  <img src="logo_estufas.png" alt="Estufas Eficientes de Leña"
       style="height:44px;width:auto;border-radius:8px;background:#fff;padding:2px 4px;display:block" />
  <div class="brand">
    DIRECCIÓN GENERAL DE ENERGÍAS RENOVABLES
    <small>Programa Nacional de Estufas Eficientes de Leña para el Bienestar</small>
  </div>
  <div class="logo-strip" aria-label="Dependencias participantes">
    <img src="1. SENER.png" alt="Energía">
    <img src="2. BIENESTAR.png" alt="Bienestar">
    <img src="4. INPI.png" alt="INPI">
  </div>
</header>

<main class="container">
  <!-- FILTROS -->
  <section class="card">
    <div class="filters">
      <div><label>Modelo de estufa</label><select id="f_modelo"><option value="">Todos</option></select></div>
      <div><label>Entidad</label><select id="f_entidad"><option value="">Todas</option></select></div>
      <div><label>Municipio</label><select id="f_municipio"><option value="">Todos</option></select></div>
      <div><label>Localidad</label><select id="f_localidad"><option value="">Todas</option></select></div>
      <div><label>Estatus</label><select id="f_estatus"><option value="">Todos</option><option>Instalada</option><option>En seguimiento</option><option>Baja</option></select></div>
      <div><label>Año/Semana</label><select id="f_week"><option value="">Todos</option></select></div>
    </div>
  </section>

  <!-- KPIs -->
  <section class="kpis">
    <div class="kpi"><div class="label">Estufas instaladas</div><div class="value" id="k_estufas">0</div></div>
    <div class="kpi"><div class="label">Población Beneficiada</div><div class="value" id="k_poblacion">0</div></div>
    <div class="kpi"><div class="label">Hogares que quieren estufa (censo)</div><div class="value" id="k_quiere_estufa">–</div></div>
    <div class="kpi"><div class="label">Seguimiento pos-instalación</div><div class="value" id="k_seguimiento">0 (0%)</div></div>
  </section>

  <!-- MAPA + PANEL DERECHO -->
  <section class="layout">
    <div class="card">
      <h2>Mapa de instalaciones</h2>
      <div id="map"></div>
    </div>

    <div style="display:grid;grid-template-rows:auto auto 1fr;gap:16px">
      <div class="card" style="height:220px">
        <h2>Instalaciones por semana</h2>
        <canvas id="chartInstalaciones"></canvas>
      </div>
      <div class="card" style="height:220px">
        <h2>Ahorro de leña (kg/mes) promedio por modelo</h2>
        <canvas id="chartAhorro"></canvas>
      </div>
      <div class="card" style="overflow:auto">
        <h2>Bitácora de actividades</h2>
        <table id="tablaBitacora" class="display" style="width:100%"></table>
      </div>
    </div>
  </section>

  <footer>Energia 2025. Dirección General de Energías Renovables</footer>
</main>

<script>
/* =================== Helpers =================== */
const $ = s => document.querySelector(s);
const fmt = n => n.toLocaleString('es-MX');
const getCss = name => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
function normaliza(s){return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');}
const gProp = (p,...keys)=>{for(const k of keys){if(p&&p[k]!=null&&p[k]!=='') return p[k]} return '';}
const num = v => { const n = Number(String(v??'').replace(/,/g,'').trim()); return isFinite(n)? n : 0; };

/* =================== Constantes =================== */
const QUIERE_COL = 'Grupo_Prioritario_SENER_REMBIO';
const START_DATE = new Date('2025-08-01');
const END_DATE   = new Date('2025-10-31');
const EJEMPLOS_POR_LOCALIDAD = 20;
const MAX_LOCALIDADES_SIN_MUN = 60;
const MODELOS = ['Modelo A','Modelo B','Modelo C'];
const PROGRAMAS = ['Transición Energética','Calor Seguro','Bienestar'];

/* =================== Estado =================== */
let CENSO_ROWS = [];
let CENSO_MAP = new Map();
let CSV_LOC_SET = null;

let LOC_GEO = null, geoLoaded=false;
let muniLayer, muniCenters = new Map(); // fallback: centro de municipio

let DATA = [];

/* =================== Filtros =================== */
const uniqSorted = arr => [...new Set(arr)].filter(Boolean).sort((a,b)=>a.localeCompare(b,'es'));
function setOptions(sel, values, firstLabel){
  const el = document.querySelector(sel);
  const current = el.value;
  el.innerHTML='';
  const optAll=document.createElement('option'); optAll.value=''; optAll.textContent=firstLabel||'Todos'; el.appendChild(optAll);
  values.forEach(v=>{const op=document.createElement('option');op.value=v;op.textContent=v;el.appendChild(op);});
  if(values.includes(current)) el.value=current;
}
function keyEML(ent, mun, loc){ return [ent||'', mun||'', loc||''].map(x=>normaliza(x)).join('|'); }

function fuenteCombos(){ return CENSO_ROWS.length? CENSO_ROWS : (LOC_GEO?.features||[]).map(f=>f.properties||{}); }
function buildEntidadFromFuente(){
  const rows = fuenteCombos();
  setOptions('#f_entidad', uniqSorted(rows.map(r=> r.ENTIDAD || r.entidad)), 'Todas');
}
function cascadeMunicipios(){
  const ent = $('#f_entidad').value;
  const base = fuenteCombos().filter(r=> !ent || (r.ENTIDAD||r.entidad)===ent);
  setOptions('#f_municipio', uniqSorted(base.map(r=> r.MUNICIPIO || r.municipio)), 'Todos');
}
function cascadeLocalidades(){
  const ent=$('#f_entidad').value, mun=$('#f_municipio').value;
  const base = fuenteCombos().filter(r=>{
    const okE=!ent || (r.ENTIDAD||r.entidad)===ent;
    const okM=!mun || (r.MUNICIPIO||r.municipio)===mun; // <- corregido
    return okE && okM;
  });
  setOptions('#f_localidad', uniqSorted(base.map(r=> r.LOCALIDAD || r.localidad || r.NOM_LOC)), 'Todas');
}
function getFilters(){
  return{
    modelo:$('#f_modelo').value,
    entidad:$('#f_entidad').value,
    municipio:$('#f_municipio').value,
    localidad:$('#f_localidad').value,
    estatus:$('#f_estatus').value,
    week:$('#f_week').value
  }
}

/* =================== CSV Censo =================== */
Papa.parse('Censo_estufas.csv', {
  download:true, header:true, skipEmptyLines:true,
  complete:(res)=>{
    CENSO_ROWS = (res.data||[]).map(r=>{
      const ENT = r.ENTIDAD || r.entidad || r['Entidad'] || '';
      const MUN = r.MUNICIPIO || r.municipio || r['Municipio'] || '';
      const LOC = r.LOCALIDAD || r.localidad || r['Localidad'] || r.NOM_LOC || '';
      const row = { ENTIDAD: ENT, MUNICIPIO: MUN, LOCALIDAD: LOC, ...r };
      CENSO_MAP.set(keyEML(ENT,MUN,LOC), row);
      return row;
    });
    CSV_LOC_SET = new Set(CENSO_ROWS.map(r => keyEML(r.ENTIDAD, r.MUNICIPIO, r.LOCALIDAD)));

    buildEntidadFromFuente(); cascadeMunicipios(); cascadeLocalidades();
    renderKPIQuiereEstufa();
    regenerateSyntheticData(); // intentamos generar si ya hay geo
    renderAll();
  }
});

/* =================== GeoJSON Localidades y Municipios =================== */
function colorByRatio(ratio){
  return ratio > 0.95 ? '#bd0026' :
         ratio > 0.90 ? '#9F2241' :
         ratio > 0.85 ? '#fd8d3c' :
         ratio > 0.80 ? '#feb24c' : '#fed976';
}

let map, layerGroup, layerControl;
function initMap(){
  if(map) return;
  map = L.map('map').setView([19.7,-101.9],8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'© OpenStreetMap'}).addTo(map);
  layerControl = L.control.layers(null, {}, {collapsed:false}).addTo(map);

  // Municipios
  fetch('estufas_municipios.geojson').then(r=>r.json()).then(geo=>{
    muniLayer = L.geoJSON(geo, {
      style: f => {
        const p = f.properties || {};
        const ratio = (p.quiere_estufa && p.hogares) ? (p.quiere_estufa / p.hogares) : 0;
        return { color:getCss('--azul'), weight:1, fillOpacity:0.6, fillColor:colorByRatio(ratio) };
      }
    }).addTo(map);
    layerControl.addOverlay(muniLayer,'Municipios');

    // Guardar centro de cada municipio para fallback
    muniLayer.eachLayer(ly=>{
      const p = ly.feature?.properties || {};
      const ent = gProp(p,'ENTIDAD','entidad');
      const mun = gProp(p,'MUNICIPIO','municipio');
      const ctr = ly.getBounds().getCenter();
      muniCenters.set(keyEML(ent,mun,''), {lat:ctr.lat, lng:ctr.lng});
    });
  });

  // Localidades
  fetch('localidades_filtradas_mich.geojson')
    .then(r=> r.ok ? r.json() : fetch('localidades_filtrdas_mich.geojson').then(r2=>r2.json()))
    .then(geo=>{
      LOC_GEO = geo; geoLoaded=true;

      // Capa Localidades (para consulta visual)
      const locaAllLayer = L.geoJSON(LOC_GEO, {
        filter: (feature)=>{
          if(!CSV_LOC_SET) return true;
          const p = feature.properties||{};
          const ent = gProp(p,'ENTIDAD','entidad');
          const mun = gProp(p,'MUNICIPIO','municipio');
          const loc = gProp(p,'LOCALIDAD','localidad','NOM_LOC');
          return CSV_LOC_SET.has(keyEML(ent,mun,loc));
        },
        pointToLayer: (feature, latlng) => {
          const p=feature.properties||{};
          const ratio = (p.quiere_estufa && p.hogares) ? (p.quiere_estufa/p.hogares) : 0;
          return L.circleMarker(latlng,{radius:4,color:'#fff',weight:1,fillColor:colorByRatio(ratio),fillOpacity:.9});
        }
      });
      layerControl.addOverlay(locaAllLayer,'Localidades');

      // Generar datos ahora que ya hay geo
      regenerateSyntheticData();
      renderAll();
    })
    .catch(()=>{ geoLoaded=false; regenerateSyntheticData(); renderAll(); });
}
initMap();

/* =================== Síntesis y visualización =================== */
function buildWeightedWeeks(){
  const start = new Date(START_DATE);
  start.setDate(start.getDate() - ((start.getDay()+6)%7));
  const weeks = [];
  while (start <= END_DATE){ weeks.push(new Date(start)); start.setDate(start.getDate()+7); }
  const weights = weeks.map((_,i)=> Math.max(1, Math.round(1 + Math.abs(Math.sin(i*0.9))*6 + Math.random()*2)));
  return {weeks, weights};
}
function pickWeighted(arr, weights){
  const sum = weights.reduce((a,b)=>a+b,0);
  let r = Math.random()*sum;
  for(let i=0;i<arr.length;i++){ if((r-=weights[i])<0) return i; }
  return arr.length-1;
}
function randomDateWeighted(){
  const {weeks, weights} = buildWeightedWeeks();
  const idx = pickWeighted(weeks, weights);
  const d = new Date(weeks[idx]);
  d.setDate(d.getDate() + Math.floor(Math.random()*7));
  if (d < START_DATE) return new Date(START_DATE);
  if (d > END_DATE)   return new Date(END_DATE);
  return d;
}
function jitter(val, span){ return val + (Math.random()-0.5)*span; }

function localitiesFromGeoAndCSV(){
  if(!geoLoaded || !LOC_GEO) return [];
  const f=getFilters();
  const feats = (LOC_GEO.features||[]);
  let filtered = feats.filter(ft=>{
    const p=ft.properties||{};
    const ent=gProp(p,'ENTIDAD','entidad');
    const mun=gProp(p,'MUNICIPIO','municipio');
    const loc=gProp(p,'LOCALIDAD','localidad','NOM_LOC');
    const okE=!f.entidad || ent===f.entidad;
    const okM=!f.municipio || mun===f.municipio;
    const okL=!f.localidad || loc===f.localidad;
    if(!(okE&&okM&&okL)) return false;
    const key = keyEML(ent,mun,loc);
    // Sólo pedimos que exista en el CSV (ya que el KPI de “quiere estufa” sí usa QUIERE_COL)
    return CENSO_MAP.has(key);
  });

  if (!f.municipio && !f.localidad && filtered.length > MAX_LOCALIDADES_SIN_MUN){
    filtered = filtered.slice(0, MAX_LOCALIDADES_SIN_MUN);
  }
  return filtered;
}

function regenerateSyntheticData(){
  DATA = [];
  const f = getFilters();

  // 1) Preferimos localidades del GeoJSON que están en el CSV
  const locs = localitiesFromGeoAndCSV();

  if (locs.length > 0){
    let seq=1;
    locs.forEach(ft=>{
      const p=ft.properties||{};
      const ent=gProp(p,'ENTIDAD','entidad');
      const mun=gProp(p,'MUNICIPIO','municipio');
      const loc=gProp(p,'LOCALIDAD','localidad','NOM_LOC');

      let baseLat=0, baseLng=0;
      if(ft.geometry && ft.geometry.type==='Point'){
        baseLng = ft.geometry.coordinates[0];
        baseLat = ft.geometry.coordinates[1];
      }else{
        // fallback mínimo por si el punto no es Point
        const cen = muniCenters.get(keyEML(ent,mun,'')) || {lat:19.7,lng:-101.9};
        baseLat = cen.lat; baseLng = cen.lng;
      }

      for(let i=0;i<EJEMPLOS_POR_LOCALIDAD;i++){
        const fecha = randomDateWeighted();
        const modelo = MODELOS[Math.floor(Math.random()*MODELOS.length)];
        const programa = PROGRAMAS[Math.floor(Math.random()*PROGRAMAS.length)];
        const consumo_base = 90 + Math.floor(Math.random()*60);
        const ahorro = 30 + Math.floor(Math.random()*40);
        const consumo_post = Math.max(10, consumo_base - ahorro);

        DATA.push({
          id: `${normaliza(loc)}-${String(seq++).padStart(5,'0')}`,
          programa, proveedor: 'Proveedor Demo',
          modelo, entidad: ent, municipio: mun,
          lat: jitter(baseLat, 0.01),
          lng: jitter(baseLng, 0.01),
          estatus: 'Instalada',
          fecha_instalacion: fecha.toISOString().slice(0,10),
          garantia_fin: '2027-12-31',
          visita_ult_fecha: fecha.toISOString().slice(0,10),
          visita_ult_hallazgo:'OK',
          consumo_base, consumo_post
        });
      }
    });
    buildWeeksFromData();
    return;
  }

  // 2) Si no hubo localidades del geo, generamos por MUNICIPIO usando su centro
  const porMun = CENSO_ROWS.filter(r=>{
    const okE=!f.entidad || r.ENTIDAD===f.entidad;
    const okM=!f.municipio || r.MUNICIPIO===f.municipio;
    return okE && okM;
  });
  const grupos = new Map();
  porMun.forEach(r=>{
    const key = keyEML(r.ENTIDAD, r.MUNICIPIO,'');
    if(!grupos.has(key)) grupos.set(key,{ent:r.ENTIDAD, mun:r.MUNICIPIO, locs:[]});
    grupos.get(key).locs.push(r.LOCALIDAD || r.NOM_LOC || '');
  });

  let seq=1;
  for(const [key,info] of grupos){
    const cen = muniCenters.get(key) || {lat:19.7,lng:-101.9};
    const sampleLocs = info.locs.slice(0, Math.min( (MAX_LOCALIDADES_SIN_MUN||60), info.locs.length ));
    sampleLocs.forEach(loc=>{
      for(let i=0;i<EJEMPLOS_POR_LOCALIDAD;i++){
        const fecha = randomDateWeighted();
        const modelo = MODELOS[Math.floor(Math.random()*MODELOS.length)];
        const programa = PROGRAMAS[Math.floor(Math.random()*PROGRAMAS.length)];
        const consumo_base = 90 + Math.floor(Math.random()*60);
        const ahorro = 30 + Math.floor(Math.random()*40);
        const consumo_post = Math.max(10, consumo_base - ahorro);
        DATA.push({
          id: `${normaliza(loc)}-${String(seq++).padStart(5,'0')}`,
          programa, proveedor:'Proveedor Demo',
          modelo, entidad: info.ent, municipio: info.mun,
          lat: jitter(cen.lat, 0.05), lng: jitter(cen.lng, 0.05),
          estatus:'Instalada',
          fecha_instalacion: fecha.toISOString().slice(0,10),
          garantia_fin:'2027-12-31',
          visita_ult_fecha: fecha.toISOString().slice(0,10),
          visita_ult_hallazgo:'OK',
          consumo_base, consumo_post
        });
      }
    });
  }
  buildWeeksFromData();
}

function isoWeekKey(dateStr){
  const d=new Date(dateStr);
  const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day+3);
  const firstThursday=new Date(d.getFullYear(),0,4);
  const diff=d-firstThursday; const week=1+Math.round(diff/604800000);
  const y=d.getFullYear(); return `${y}-W${String(week).padStart(2,'0')}`;
}
function sortWeekKeys(a,b){const [ya,wa]=a.split('-W').map(Number);const [yb,wb]=b.split('-W').map(Number);return ya===yb?wa-wb:ya-yb;}
function buildWeeksFromData(){
  const weeks=[...new Set(DATA.map(d=>isoWeekKey(d.fecha_instalacion)))].sort(sortWeekKeys);
  if($('#f_week') && $('#f_week').options.length<=1){
    weeks.forEach(w=>{const op=document.createElement('option');op.value=op.textContent=w;$('#f_week').appendChild(op);});
  }
}
function getFilteredRows(){
  const f=getFilters();
  return DATA.filter(d=>
    (!f.modelo   || d.modelo===f.modelo) &&
    (!f.entidad  || d.entidad===f.entidad) &&
    (!f.municipio|| d.municipio===f.municipio) &&
    (!f.estatus  || d.estatus===f.estatus) &&
    (!f.week     || isoWeekKey(d.fecha_instalacion)===f.week)
  );
}
function renderKPIs(rows){
  const total=rows.length;
  const seg=rows.filter(r=>r.estatus==='En seguimiento').length;
  $('#k_estufas').textContent = fmt(total);
  $('#k_poblacion').textContent = fmt(Math.round(total*4.2));
  $('#k_seguimiento').textContent = seg+" ("+(total?Math.round(seg/total*100):0)+"%)";
}
function renderKPIQuiereEstufa(){
  const f=getFilters();
  let totalQuiere = 0;
  CENSO_ROWS.forEach(r=>{
    const okE=!f.entidad || r.ENTIDAD===f.entidad;
    const okM=!f.municipio || r.MUNICIPIO===f.municipio;
    const okL=!f.localidad || r.LOCALIDAD===f.localidad;
    if (okE && okM && okL) totalQuiere += num(r[QUIERE_COL]);
  });
  $('#k_quiere_estufa').textContent = fmt(totalQuiere);
}

/* ====== MAPA ====== */
function renderMap(rows){
  if(!map) initMap();

  if(layerGroup){ map.removeLayer(layerGroup); }
  layerGroup = L.layerGroup().addTo(map);              // <- IMPORTANTE: mostrar capa
  if(layerControl && !window._addedEstufas){
    layerControl.addOverlay(layerGroup,'Estufas');
    window._addedEstufas = true;
  }

  rows.forEach(r=>{
    const color = getCss('--guinda');
    const icon=L.divIcon({html:`<div style="width:14px;height:14px;border-radius:50%;background:${color};border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.2)"></div>`});
    L.marker([r.lat,r.lng],{icon}).addTo(layerGroup)
      .bindPopup(`<b>${r.programa}</b><br/>${r.modelo} · ${r.estatus}<br/>${r.municipio}, ${r.entidad}<br/>Instalada: ${new Date(r.fecha_instalacion).toLocaleDateString('es-MX')}`);
  });

  try{
    if(rows.length){
      const g = L.featureGroup(rows.map(r=>L.marker([r.lat,r.lng])));
      map.fitBounds(g.getBounds(),{padding:[20,20], maxZoom:12});
    }
  }catch(e){}
}

/* ====== GRÁFICAS ====== */
function renderCharts(rows){
  const byWeek={};
  rows.forEach(r=>{const wk=isoWeekKey(r.fecha_instalacion); byWeek[wk]=(byWeek[wk]||0)+1;});
  const labels=Object.keys(byWeek).sort(sortWeekKeys);
  const counts=labels.map(k=>byWeek[k]);

  const cfg1={type:'bar',data:{labels,datasets:[{label:'Instalaciones',data:counts,backgroundColor:getCss('--guinda')}]},options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}};
  if(!window.chart1){ window.chart1=new Chart($('#chartInstalaciones'),cfg1);} else { window.chart1.data.labels=labels; window.chart1.data.datasets[0].data=counts; window.chart1.update(); }

  const byModel={}; rows.forEach(r=>{const ah=Math.max(0,r.consumo_base-r.consumo_post); if(!byModel[r.modelo]) byModel[r.modelo]={s:0,c:0}; byModel[r.modelo].s+=ah; byModel[r.modelo].c++;});
  const ml=Object.keys(byModel).sort(); const av=ml.map(m=>(byModel[m].s/byModel[m].c).toFixed(1));
  const cfg2={type:'bar',data:{labels:ml,datasets:[{label:'Ahorro promedio (kg/mes)',data:av,backgroundColor:getCss('--dorado')}]},options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}};
  if(!window.chart2){ window.chart2=new Chart($('#chartAhorro'),cfg2);} else { window.chart2.data.labels=ml; window.chart2.data.datasets[0].data=av; window.chart2.update(); }
}

/* ====== Render general ====== */
function renderAll(){
  const rows=getFilteredRows();
  renderKPIs(rows);
  renderMap(rows);
  renderCharts(rows);
}
function buildWeeksFromData(){
  const weeks=[...new Set(DATA.map(d=>isoWeekKey(d.fecha_instalacion)))].sort(sortWeekKeys);
  const sel = $('#f_week');
  if(sel && sel.options.length<=1){ weeks.forEach(w=>{const op=document.createElement('option');op.value=op.textContent=w; sel.appendChild(op);}); }
}

/* ====== UI init y eventos ====== */
setOptions('#f_modelo', MODELOS, 'Todos');
['#f_modelo','#f_estatus','#f_week'].forEach(s=>$(s).addEventListener('change',()=>renderAll()));
$('#f_entidad').addEventListener('change',()=>{ cascadeMunicipios(); cascadeLocalidades(); regenerateSyntheticData(); renderKPIQuiereEstufa(); renderAll(); });
$('#f_municipio').addEventListener('change',()=>{ cascadeLocalidades(); regenerateSyntheticData(); renderKPIQuiereEstufa(); renderAll(); });
$('#f_localidad').addEventListener('change',()=>{ regenerateSyntheticData(); renderKPIQuiereEstufa(); renderAll(); });
</script>
</body>
</html>
