<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tablero de Estufas Ecológicas · MVP</title>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

  <style>
    :root{
      --verde-oscuro:#0f302c;   /* header */
      --guinda:#7a1530;          /* barras y acentos */
      --dorado:#c2a166;          /* acento */
      --gris-card:#f4f6f8;
      --borde:#e6e9ed;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family:'Noto Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      font-size:11px; /* pedido: base 11 */
      color:#1f2937;
      background:#fafbfc;
    }

    /* Header */
    .appbar{
      background:var(--verde-oscuro);
      color:#fff;
      padding:14px 18px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      position:sticky; top:0; z-index:50;
    }
    .app-title{
      margin:0;
      font-weight:700;
      letter-spacing:.3px;
    }
    .app-sub{
      margin:2px 0 0;
      opacity:.9;
    }

    /* Barra de logos */
    .logos{
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
      padding:6px 12px; background:var(--verde-oscuro);
      border-top:1px solid rgba(255,255,255,.06);
    }
    .logo-chip{
      background:#fff; border-radius:6px; padding:4px 8px;
      display:flex; align-items:center; gap:6px; box-shadow:0 1px 0 rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.05);
    }
    .logo-chip img{ display:block; height:24px }

    /* Área principal */
    .container-lg{ max-width:1200px }

    /* Filtros */
    .filters .form-select{
      font-size:11px;
    }
    .filters .col{ margin-bottom:10px }

    /* Cards KPI */
    .kpi-card{
      background:#fff; border:1px solid var(--borde); border-radius:10px;
      padding:14px 16px; height:72px;
      display:flex; flex-direction:column; justify-content:center;
    }
    .kpi-title{ font-size:11px; color:#6b7280 }
    .kpi-value{ font-size:20px; font-weight:700; color:#111827; margin-top:2px }

    /* Tarjetas secciones */
    .section-card{
      background:#fff; border:1px solid var(--borde); border-radius:12px;
      padding:14px; height:100%;
    }
    .section-title{
      font-weight:700; margin:0 0 8px; color:#111827;
    }

    /* Mapa */
    #map{ width:100%; height:360px; border-radius:10px; border:1px solid var(--borde) }

    /* Galería */
    .gallery-card{
      width:140px; background:#fff; border:1px solid var(--borde); border-radius:12px; overflow:hidden
    }
    .gallery-card img{ width:100%; height:110px; object-fit:cover }
    .gallery-body{ padding:10px }
    .gallery-title{ font-weight:600; margin:0 0 4px }
    .gallery-sub{ color:#6b7280; margin:0 }

    /* DataTable */
    table.dataTable tbody tr:hover{ background:#fafafa }
    .dataTables_wrapper .dataTables_paginate .paginate_button{
      padding:0.2rem 0.5rem!important; font-size:11px!important;
    }

    /* Leyenda del mapa */
    .legend{
      line-height:1.1em; background:#fff; padding:8px 10px; border-radius:8px; border:1px solid var(--borde);
      box-shadow:0 1px 0 rgba(0,0,0,.05)
    }
    .legend i{ width:12px; height:12px; display:inline-block; margin-right:6px; border-radius:2px; border:1px solid rgba(0,0,0,.2) }
  </style>
</head>
<body>

  <!-- App bar -->
  <header class="appbar">
    <div class="container-lg d-flex justify-content-between align-items-center flex-wrap">
      <div class="pe-2">
        <h1 class="app-title">DIRECCIÓN GENERAL DE ENERGÍAS RENOVABLES</h1>
        <p class="app-sub">Programa nacional de estufas eficientes de leña para el Bienestar · Dirección de Biocombustibles</p>
      </div>

      <!-- Barra de logos (fondo blanco en cada uno) -->
      <div class="logos">
        <span class="logo-chip">
          <img src="img/1. SENER.png" alt="SENER" /> <!-- <-- AJUSTA ESTA RUTA -->
        </span>
        <span class="logo-chip">
          <img src="img/2. BIENESTAR.png" alt="Bienestar" /> <!-- <-- AJUSTA ESTA RUTA -->
        </span>
        <span class="logo-chip">
          <img src="img/3. Logo_Ciencia.png" alt="Ciencia y Tecnología" /> <!-- <-- AJUSTA ESTA RUTA -->
        </span>
        <span class="logo-chip">
          <img src="img/4. INPI.png" alt="INPI" /> <!-- <-- AJUSTA ESTA RUTA -->
        </span>
      </div>
    </div>
  </header>

  <main class="container-lg my-3">

    <!-- Filtros -->
    <section class="filters row g-3 mb-2">
      <div class="col-12 col-md-2">
        <label class="form-label mb-1">Programa</label>
        <select class="form-select">
          <option>Todos</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <label class="form-label mb-1">Proveedor</label>
        <select class="form-select">
          <option>Todos</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <label class="form-label mb-1">Modelo de estufa</label>
        <select class="form-select">
          <option>Todos</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <label class="form-label mb-1">Entidad</label>
        <select class="form-select">
          <option>Todos</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <label class="form-label mb-1">Estatus</label>
        <select class="form-select">
          <option>Todos</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <label class="form-label mb-1">Año</label>
        <select class="form-select">
          <option>Todos</option>
        </select>
      </div>
    </section>

    <!-- KPIs -->
    <section class="row g-3 mb-2">
      <div class="col-12 col-md-3">
        <div class="kpi-card">
          <div class="kpi-title">ESTUFAS INSTALADAS</div>
          <div class="kpi-value" id="kpi-estufas">7</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="kpi-card">
          <div class="kpi-title">HOGARES BENEFICIADOS</div>
          <div class="kpi-value" id="kpi-hogares">7</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="kpi-card">
          <div class="kpi-title">HOGARES QUE QUIEREN ESTUFA (CENSO)</div>
          <div class="kpi-value" id="kpi-quiere">21,810</div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="kpi-card">
          <div class="kpi-title">SEGUIMIENTO POS-INSTALACIÓN</div>
          <div class="kpi-value"><span id="kpi-seg">1</span> <span style="color:#6b7280">(14%)</span></div>
        </div>
      </div>
    </section>

    <!-- Mapa + gráfica -->
    <section class="row g-3">
      <div class="col-12 col-lg-7">
        <div class="section-card">
          <h3 class="section-title">Mapa de instalaciones</h3>
          <div id="map"></div>
        </div>
      </div>

      <div class="col-12 col-lg-5">
        <div class="section-card mb-3">
          <h3 class="section-title">Instalaciones por semana</h3>
          <canvas id="chartSemanas" height="140"></canvas>
        </div>

        <div class="section-card">
          <h3 class="section-title">Ahorro de leña (kg/mes) promedio por modelo</h3>
          <canvas id="chartAhorro" height="140"></canvas>
        </div>
      </div>
    </section>

    <!-- Galería + tabla -->
    <section class="row g-3 mt-1">
      <div class="col-12 col-lg-7">
        <div class="section-card">
          <h3 class="section-title">Galería fotográfica del programa</h3>
          <div class="d-flex gap-3 flex-wrap">
            <div class="gallery-card">
              <img src="estufas_ecologicas/img/estufa_1.jpg" alt="Instalación y capacitación en sitio"> <!-- opcional -->
              <div class="gallery-body">
                <p class="gallery-title">Instalación de estufa</p>
                <p class="gallery-sub">Instalación y capacitación en sitio</p>
              </div>
            </div>

            <div class="gallery-card">
              <img src="estufas_ecologicas/img/estufa_2.jpg" alt="Prueba y verificación de tiraje">
              <div class="gallery-body">
                <p class="gallery-title">Encendido de prueba</p>
                <p class="gallery-sub">Prueba y verificación de tiraje</p>
              </div>
            </div>

            <div class="gallery-card">
              <img src="estufas_ecologicas/img/estufa_3.jpg" alt="Taller con promotores">
              <div class="gallery-body">
                <p class="gallery-title">Taller con promotores</p>
                <p class="gallery-sub">Taller con promotores del programa</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-5">
        <div class="section-card">
          <h3 class="section-title">Bitácora (tabla)</h3>
          <div class="table-responsive">
            <table id="tablaBitacora" class="table table-sm table-hover" style="width:100%">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Programa</th>
                  <th>Proveedor</th>
                  <th>Modelo</th>
                  <th>Entidad</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>EST-0001</td><td>Transición Energética</td><td>EcoCalor SA</td><td>Modelo A</td><td>Jalisco</td></tr>
                <tr><td>EST-0002</td><td>Transición Energética</td><td>EcoCalor SA</td><td>Modelo B</td><td>Jalisco</td></tr>
                <tr><td>EST-0003</td><td>Bienestar</td><td>HogarLimpio</td><td>Modelo A</td><td>Michoacán</td></tr>
                <tr><td>EST-0004</td><td>Bienestar</td><td>HogarLimpio</td><td>Modelo C</td><td>Veracruz</td></tr>
                <tr><td>EST-0005</td><td>Calor Seguro</td><td>BioEstufa MX</td><td>Modelo B</td><td>Puebla</td></tr>
                <tr><td>EST-0006</td><td>Calor Seguro</td><td>BioEstufa MX</td><td>Modelo C</td><td>Puebla</td></tr>
                <tr><td>EST-0007</td><td>Transición Energética</td><td>EcoCalor SA</td><td>Modelo A</td><td>Jalisco</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <div class="text-center text-muted my-4" style="font-size:10px">
      Identidad visual: Noto Sans · Fondo blanco · Paleta institucional · MVP estático listo para Vercel
    </div>
  </main>

  <script>
    // ========= MAPA =========
    const map = L.map('map', { scrollWheelZoom:true }).setView([19.65, -101.85], 8);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Capa de municipios (GeoJSON)
    const MUNICIPIOS_URL = 'estufas_ecologicas/municipios_censo.geojson'; // <-- AJUSTA ESTA RUTA
    let municipiosLayer = null;

    fetch(MUNICIPIOS_URL)
      .then(r => r.json())
      .then(geo => {
        municipiosLayer = L.geoJSON(geo, {
          style: f => ({
            color:'#7a1530',
            weight:1,
            fill:true,
            fillOpacity:.45,
            fillColor:'#b15a6e'
          }),
          onEachFeature: (feat, lyr) => {
            const props = feat.properties || {};
            const ent = props.ENTIDAD || props.nomgeoent || props.NOMGEO || '—';
            const mun = props.MUNICIPIO || props.nomgeomun || '—';
            lyr.bindTooltip(`${mun}, ${ent}`, {sticky:true});
          }
        }).addTo(map);

        try{ map.fitBounds(municipiosLayer.getBounds(), {padding:[20,20]}); }catch(e){}
      });

    // Puntos DEMO colocados **dentro** del polígono (zona Michoacán)
    const DATA = [
      { id:'EST-0001', lat:19.647, lng:-102.056, titulo:'Charapan · Instalación' },
      { id:'EST-0002', lat:19.554, lng:-101.983, titulo:'Paracho · Seguimiento' },
      { id:'EST-0003', lat:19.713, lng:-101.840, titulo:'Cherán · Garantía' }
    ];

    const icon = L.divIcon({
      html:`<div style="
        width:10px;height:10px;border-radius:50%;
        background:#0ea5a6;border:1px solid #0b7c7d;box-shadow:0 0 0 2px rgba(14,165,166,.18);">
      </div>`,
      className:'', iconSize:[10,10]
    });

    DATA.forEach(p=>{
      L.marker([p.lat,p.lng], {icon})
        .addTo(map)
        .bindPopup(`<strong>${p.titulo}</strong><br/><span style="color:#6b7280">${p.id}</span>`);
    });

    // Leyenda (rango de saturación para el polígono)
    const legend = L.control({position:'bottomright'});
    legend.onAdd = function(){
      const div = L.DomUtil.create('div','legend');
      div.innerHTML = `
        <div style="font-weight:700;margin-bottom:6px">Leyenda</div>
        <div><i style="background:#b15a6e"></i> Municipios del programa</div>
        <div style="margin-top:6px"><i style="background:#0ea5a6"></i> Instalación (ejemplo)</div>
      `;
      return div;
    };
    legend.addTo(map);

    // ========= CHARTS =========
    // Instalaciones por semana
    const semanas = ['2023-W40','2023-W42','2023-W45','2023-W52','2024-W07','2024-W10'];
    const valores = [9,9,8,9,9,9];

    const ctx1 = document.getElementById('chartSemanas').getContext('2d');
    new Chart(ctx1,{
      type:'bar',
      data:{
        labels:semanas,
        datasets:[{
          label:'Instalaciones',
          data:valores,
          backgroundColor:'#7a1530'
        }]
      },
      options:{
        responsive:true,
        plugins:{ legend:{display:true, labels:{ boxWidth:10, usePointStyle:true }}},
        scales:{
          x:{ grid:{display:false}, ticks:{ font:{ size:11 } } },
          y:{ grid:{color:'#eee'}, ticks:{ stepSize:0.5, font:{ size:11 } } }
        }
      }
    });

    // Ahorro promedio por modelo (demo)
    const ctx2 = document.getElementById('chartAhorro').getContext('2d');
    new Chart(ctx2,{
      type:'bar',
      data:{
        labels:['Modelo A','Modelo B','Modelo C'],
        datasets:[{
          label:'Ahorro promedio (kg/mes)',
          data:[52,44,19],
          backgroundColor:'#c58f4a'
        }]
      },
      options:{
        responsive:true,
        plugins:{ legend:{display:true, labels:{ boxWidth:10, usePointStyle:true }}},
        scales:{
          x:{ grid:{display:false}, ticks:{ font:{ size:11 } } },
          y:{ grid:{color:'#eee'}, ticks:{ stepSize:10, font:{ size:11 } } }
        }
      }
    });

    // ========= TABLA =========
    $(function(){
      $('#tablaBitacora').DataTable({
        pageLength:7,
        lengthChange:false,
        info:false,
        language:{
          search:"Search:",
          paginate:{ previous:"Previous", next:"Next" },
          zeroRecords:"Sin registros"
        }
      });
    });
  </script>
</body>
</html>
