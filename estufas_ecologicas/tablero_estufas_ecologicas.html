<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Programa Nacional de Estufas Eficientes de Leña para el Bienestar · DGER</title>

  <!-- Tipografía -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- jQuery + DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --guinda:#9F2241; --guinda-osc:#691C32; --azul:#10312B;
      --dorado:#BC955C; --beige:#DDC9A3; --gris-700:#6F7271; --gris-500:#98989A;
      --verde:#8FAB85; --fondo:#ffffff; --panel:#f6f7f8; --borde:#eaecf0; --texto:#1b1f29;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Noto Sans',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:11pt;line-height:1.35;color:var(--texto);background:var(--fondo)}
    header{background:var(--azul);color:#fff;padding:18px 24px;display:flex;gap:16px;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,.08);position:relative}
    .brand{font-size:22px;font-weight:800}
    .brand small{display:block;font-weight:600;opacity:.9}
    .logo-strip{position:absolute;right:16px;top:10px;display:flex;gap:12px;align-items:center;background:#fff;padding:8px 12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.12);max-width:60vw}
    .logo-strip img{height:28px;width:auto;display:block;background:#fff;padding:2px 4px;border-radius:6px}
    @media (max-width:900px){.logo-strip{display:none}}

    .container{max-width:1200px;margin:24px auto;padding:0 16px}

    /* Filtros */
    .filters{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:12px;margin-bottom:18px}
    .filters label{font-size:10pt;opacity:.8}
    .filters select{width:100%;padding:10px 12px;border:1px solid var(--borde);border-radius:12px;background:#fff;outline:none}
    .filters select:focus{border-color:var(--guinda);box-shadow:0 0 0 3px #9f22412a}

    /* KPIs */
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:0 0 18px}
    .kpi{background:var(--panel);border:1px solid var(--borde);border-radius:14px;padding:16px}
    .kpi .label{font-size:10pt;letter-spacing:.3px;color:var(--gris-700)}
    .kpi .value{font-size:24px;font-weight:800;color:var(--azul)}

    /* Layout y tarjetas */
    .layout{display:grid;grid-template-columns:1.15fr .85fr;gap:16px}
    .card{background:var(--panel);border:1px solid var(--borde);border-radius:16px;padding:16px}
    h2{margin:0 0 10px;font-size:16pt;color:var(--guinda-osc)}
    #map{height:360px;border-radius:12px;overflow:hidden;border:1px solid var(--borde);background:#fff}

    /* Galería */
    .gallery{margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .thumb{display:block;background:#fff;border:1px solid var(--borde);border-radius:12px;padding:10px}
    .thumb img{width:100%;height:120px;object-fit:cover;border-radius:8px;cursor:zoom-in}
    .thumb figcaption{font-size:10pt;margin-top:6px;color:var(--gris-700)}

    /* DataTables */
    table.dataTable thead th{background:#fff;color:var(--azul)}
    table.dataTable tbody tr:hover{background:#fafafa}

    footer{margin:28px 0 48px;text-align:center;font-size:10pt;color:var(--gris-700)}

    @media (max-width:1000px){
      .filters{grid-template-columns:repeat(2,1fr)}
      .kpis{grid-template-columns:repeat(2,1fr)}
      .layout{grid-template-columns:1fr}
      .gallery{grid-template-columns:1fr 1fr}
    }

    .leaflet-container{z-index:0}.info.legend{z-index:400}

    /* Lightbox */
    .lightbox{display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,.85); align-items:center; justify-content:center; padding:24px;}
    .lightbox.open{display:flex}
    .lightbox img{max-width:92vw; max-height:86vh; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .lightbox .close{position:absolute; top:16px; right:20px; color:#fff; font-size:32px; line-height:1; cursor:pointer; background:transparent; border:0; padding:6px 10px;}
    .lightbox .close:focus{ outline:2px solid #fff3; outline-offset:2px; border-radius:6px; }

    /* ====== Tipografía y colores institucionales ====== */
    :root{ --vino:#7A0019; --oro:#B6864D; --gris:#f6f7f9; --borde:#e3e6ea; --texto:#1c1f23; }
    h1, h2, h3, .title, .card h2 { font-family: 'Patria','Noto Sans',serif; letter-spacing:.2px; }
    .card h2{ font-size:1.35rem; margin:0 0 .75rem 0; color:var(--vino); }

    /* ====== Tarjetas ====== */
    .card{ border:1px solid var(--borde); border-radius:16px; background:#fff; box-shadow:0 4px 14px rgba(0,0,0,.05); padding:18px 20px; }

    /* ====== Tabla Bitácora ====== */
    #tablaBitacora{ width:100% !important; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; background:#fff; box-shadow:0 4px 14px rgba(0,0,0,.04); }
    #tablaBitacora thead th{ position:sticky; top:0; background:linear-gradient(0deg,var(--vino),#8b0e27); color:#fff; font-weight:600; padding:10px 12px; border-bottom:0; z-index:1; }
    #tablaBitacora tbody td{ padding:10px 12px; border-bottom:1px solid var(--borde); vertical-align:top; }
    #tablaBitacora tbody tr:nth-child(even){ background:var(--gris); }
    #tablaBitacora tbody tr:hover{ background:#eef3ff; }

    .dataTables_wrapper .dataTables_filter{ float:right; text-align:right; margin:12px 0; }
    .dataTables_wrapper .dataTables_filter input{ border:1px solid var(--borde); border-radius:999px; padding:8px 12px; outline:none; }
    .dataTables_wrapper .dataTables_length select{ border:1px solid var(--borde); border-radius:10px; padding:6px 10px; }
    .dataTables_wrapper .dataTables_paginate .paginate_button{ border-radius:10px !important; border:1px solid var(--borde) !important; background:#fff !important; margin:0 2px !important; }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current{ background:var(--oro) !important; color:#fff !important; border-color:var(--oro) !important; }

    /* ====== Donut Meta (estilo base) ====== */
    .meta-grid{ display:grid; grid-template-columns:1.2fr .8fr; gap:16px; align-items:center; }
    .sidecard{ background:#f3f5f7; border:1px solid var(--borde); border-radius:14px; padding:14px 16px; }
    .state-list{ list-style:none; padding:0; margin:6px 0 12px 0; display:grid; gap:6px; }
    .state-list li{ display:flex; justify-content:space-between; align-items:center; background:#fff; border:1px solid var(--borde); border-radius:10px; padding:8px 10px; cursor:pointer; }
    .state-list li.active{ outline:2px solid var(--vino); }
    .state-left{ display:flex; align-items:center; gap:8px; }
    .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
    .legend-mini{ background:#fff; border:1px dashed var(--borde); border-radius:10px; padding:8px; display:grid; gap:6px; }
    .legend-mini div{ display:flex; justify-content:space-between; padding:6px 8px; border-radius:8px; }
    .legend-mini div span.value{ font-weight:800; }

    /* === Ajustes de tamaño y densidad para el donut (compacto como las tablas) === */
    #seccion-meta{ padding:14px !important; }
    #pastelMeta{ height:300px !important; max-height:320px; display:block; }
    .meta-grid{ grid-template-columns: 1fr .85fr; gap:12px; }
    .sidecard{ padding:10px 12px; }
    .sidecard h3{ margin:2px 0 6px 0; font-size:1rem; }
    .state-list li{ padding:6px 8px; }
    .legend-mini div{ padding:5px 6px; }

    @media (max-width:1000px){
      #pastelMeta{ height:260px !important; }
      .meta-grid{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
<header>
  <img src="logo_estufas.png" alt="Estufas Eficientes de Leña" style="height:44px;width:auto;border-radius:8px;background:#fff;padding:2px 4px;display:block" />
  <div class="brand">
    DIRECCIÓN GENERAL DE ENERGÍAS RENOVABLES
    <small>Programa Nacional de Estufas Eficientes de Leña para el Bienestar</small>
  </div>
  <div class="logo-strip" aria-label="Dependencias participantes">
    <img src="1. SENER.png" alt="Energía">
    <img src="2. BIENESTAR.png" alt="Bienestar">
    <img src="4. INPI.png" alt="INPI">
  </div>
</header>

<main class="container">
  <!-- FILTROS -->
  <section class="card">
    <div class="filters">
      <div><label>Modelo de estufa</label><select id="f_modelo"><option value="">Todos</option></select></div>
      <div><label>Entidad</label><select id="f_entidad"><option value="">Todas</option></select></div>
      <div><label>Municipio</label><select id="f_municipio"><option value="">Todos</option></select></div>
      <div><label>Localidad</label><select id="f_localidad"><option value="">Todas</option></select></div>
      <div><label>Estatus</label><select id="f_estatus"><option value="">Todos</option><option>Instalada</option><option>En seguimiento</option><option>Baja</option></select></div>
      <div><label>Año/Semana</label><select id="f_week"><option value="">Todos</option></select></div>
    </div>
  </section>

  <!-- KPIs -->
  <section class="kpis">
    <div class="kpi"><div class="label">Estufas instaladas</div><div class="value" id="k_estufas">–</div></div>
    <div class="kpi"><div class="label">Población Beneficiada</div><div class="value" id="k_poblacion">–</div></div>
    <div class="kpi"><div class="label">Hogares que quieren estufa (censo)</div><div class="value" id="k_quiere_estufa">–</div></div>
    <div class="kpi"><div class="label">Seguimiento pos-instalación</div><div class="value" id="k_seguimiento">–</div></div>
  </section>

  <!-- MAPA + PANEL DERECHO -->
  <section class="layout">
    <div class="card">
      <h2>Mapa de instalaciones</h2>
      <div id="map"></div>

      <h3 style="margin:12px 0 6px;color:var(--azul)">Galería fotográfica del programa</h3>
      <div class="gallery">
        <figure class="thumb">
          <img src="./estufa_1.jpg" alt="Instalación de estufa" onclick="openLightbox(this.src,this.alt)">
          <figcaption>Instalación y capacitación en sitio</figcaption>
        </figure>
        <figure class="thumb">
          <img src="./estufa_2.jpg" alt="Encendido de prueba y verificación de tiraje" onclick="openLightbox(this.src,this.alt)">
          <figcaption>Encendido de prueba y verificación de tiraje</figcaption>
        </figure>
        <figure class="thumb">
          <img src="./estufa_3.jpg" alt="Taller con promotores del programa" onclick="openLightbox(this.src,this.alt)">
          <figcaption>Taller con promotores del programa</figcaption>
        </figure>
      </div>
    </div>

    <div style="display:grid;grid-template-rows:auto auto 1fr;gap:16px">
      <div class="card" style="height:220px">
        <h2>Instalaciones por semana</h2>
        <canvas id="chartInstalaciones"></canvas>
      </div>
      <div class="card" style="height:220px">
        <h2>Ahorro de leña (kg/mes) promedio por modelo</h2>
        <canvas id="chartAhorro"></canvas>
      </div>
      <div class="card" style="overflow:auto">
        <h2>Bitácora de actividades</h2>
        <table id="tablaBitacora" class="display" style="width:100%"></table>
      </div>
      <div id="tab-seg" class="tab-pane active">
        <table id="tablaSeg" class="display" style="width:100%"></table>
      </div>
      <div id="tab-con" class="tab-pane">
        <table id="tablaCon" class="display" style="width:100%"></table>
      </div>
    </div>
  </section>

  <!-- ===== Donut Meta Nacional ===== -->
  <section class="card" id="seccion-meta" style="margin-bottom:16px">
    <h2>Meta nacional y avance por estado</h2>
    <div class="meta-grid">
      <canvas id="pastelMeta"></canvas>
      <aside class="sidecard">
        <h3>Selecciona un estado del gráfico</h3>
        <ul class="state-list" id="stateList">
          <!-- se llena por JS -->
        </ul>
        <div class="legend-mini">
          <div><span>Meta del estado</span><span class="value" id="miniMeta">—</span></div>
          <div><span>Estufas construidas</span><span class="value" id="miniBuilt">—</span></div>
          <div><span>Faltan para la meta</span><span class="value" id="miniMissing">—</span></div>
          <div><span>Avance</span><span class="value" id="miniPct">—</span></div>
        </div>
      </aside>
    </div>
  </section>

  <!-- SECCIÓN DATOS DETALLADOS -->
  <section class="container" id="seccion-datos" style="max-width:1200px;margin:20px auto;padding:0 0">
    <div class="card" style="padding:14px;margin-bottom:16px">
      <h2 style="margin:0 0 10px;font-size:16px">Tabla de Localidades (Censo)</h2>
      <table id="tablaLocalidades" class="display" style="width:100%"></table>
    </div>
    <div class="card" style="padding:14px">
      <h2 style="margin:0 0 10px;font-size:16px">Priorización por Municipio</h2>
      <table id="tablaRanking" class="display" style="width:100%"></table>
    </div>
  </section>

  <footer>Energia 2025. Dirección General de Energías Renovables</footer>
</main>

<!-- ===== Datos demo base ===== -->
<script>
  const DATA = [
    {id:"EST-0001", programa:"Transición Energética", proveedor:"EcoCalor SA", modelo:"Modelo A", entidad:"Michoacán", municipio:"Paracho",      lat:19.658,  lng:-102.048,  estatus:"Instalada",      fecha_instalacion:"2023-11-05", garantia_fin:"2025-11-05", visita_ult_fecha:"2024-05-20", visita_ult_hallazgo:"OK",            consumo_base:120, consumo_post:60},
    {id:"EST-0002", programa:"Transición Energética", proveedor:"EcoCalor SA", modelo:"Modelo B", entidad:"Michoacán", municipio:"Charapan",     lat:19.593,  lng:-102.304,  estatus:"En seguimiento", fecha_instalacion:"2024-02-14", garantia_fin:"2026-02-14", visita_ult_fecha:"2024-06-10", visita_ult_hallazgo:"Tiraje bajo",   consumo_base:100, consumo_post:70},
    {id:"EST-0003", programa:"Bienestar",              proveedor:"HogarLimpio", modelo:"Modelo A", entidad:"Michoacán", municipio:"Cherán",       lat:19.687,  lng:-101.953,  estatus:"Garantía",       fecha_instalacion:"2022-09-10", garantia_fin:"2024-09-10", visita_ult_fecha:"2024-04-02", visita_ult_hallazgo:"Fisura leve",   consumo_base:130, consumo_post:80},
    {id:"EST-0004", programa:"Bienestar",              proveedor:"HogarLimpio", modelo:"Modelo C", entidad:"Michoacán", municipio:"Nahuatzen",    lat:19.643,  lng:-101.861,  estatus:"Instalada",      fecha_instalacion:"2021-07-22", garantia_fin:"2023-07-22", visita_ult_fecha:"2023-12-01", visita_ult_hallazgo:"OK",            consumo_base:110, consumo_post:65},
    {id:"EST-0005", programa:"Calor Seguro",           proveedor:"BioEstufa MX", modelo:"Modelo B", entidad:"Michoacán", municipio:"Quiroga",     lat:19.6638, lng:-101.5250, estatus:"Instalada",      fecha_instalacion:"2024-03-05", garantia_fin:"2026-03-05", visita_ult_fecha:"2024-06-18", visita_ult_hallazgo:"OK",            consumo_base:140, consumo_post:75},
    {id:"EST-0006", programa:"Calor Seguro",           proveedor:"BioEstufa MX", modelo:"Modelo C", entidad:"Michoacán", municipio:"Los Reyes",   lat:19.595,  lng:-102.478,  estatus:"Baja",           fecha_instalacion:"2020-05-12", garantia_fin:"2022-05-12", visita_ult_fecha:"2022-06-01", visita_ult_hallazgo:"No operativa",  consumo_base:115, consumo_post:115},
    {id:"EST-0007", programa:"Transición Energética",  proveedor:"EcoCalor SA",  modelo:"Modelo A", entidad:"Michoacán", municipio:"Paracho",     lat:19.670,  lng:-102.089,  estatus:"Instalada",      fecha_instalacion:"2023-12-30", garantia_fin:"2025-12-30", visita_ult_fecha:"2024-05-10", visita_ult_hallazgo:"OK",            consumo_base:118, consumo_post:62}
  ];
</script>

<script>
  /* =================== Helpers & estado =================== */
  const $ = s=>document.querySelector(s);
  const fmt = n=> Number(n||0).toLocaleString('es-MX');
  const getCss = name => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  function normaliza(s){return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');}
  const gProp = (p, ...keys) => { for (const k of keys){ if (p && p[k]!=null && p[k]!=='') return p[k]; } return ''; };
  const num = v => { const n = Number(String(v??'').replace(/,/g,'').trim()); return isFinite(n)? n : 0; };
  const eqN = (a,b)=> !b || normaliza(a)===normaliza(b);

  const QUIERE_COL = 'Grupo_Prioritario_SENER_REMBIO';
  const MODELOS = ['Modelo A','Modelo B','Modelo C'];
  const PROGRAMAS = ['Transición Energética','Calor Seguro','Bienestar'];

  const START_DATE = new Date('2025-08-01');
  const END_DATE   = new Date('2025-10-31');
  const EJEMPLOS_POR_MUNICIPIO = 20;

  let CENSO_ROWS = [];
  let CSV_LOC_SET = null;
  let LOC_GEO = null;

  let SYNTH = [];
  let csvReady = false, geoReady = false;

  /* =================== Filtros (combos) =================== */
  const uniqSorted = arr => [...new Set(arr)].filter(v=>v!=='' && v!=null).sort((a,b)=>a.localeCompare(b,'es'));

  function setOptions(sel, values, firstLabel){
    const el = document.querySelector(sel);
    const current = el.value;
    el.innerHTML='';
    const optAll=document.createElement('option'); optAll.value=''; optAll.textContent=firstLabel||'Todos'; el.appendChild(optAll);
    values.forEach(v=>{const op=document.createElement('option');op.value=v;op.textContent=v;el.appendChild(op);});
    if(values.includes(current)) el.value=current;
  }

  function fuenteCombos(){
    if (CENSO_ROWS && CENSO_ROWS.length) return CENSO_ROWS;
    const feats = (LOC_GEO && Array.isArray(LOC_GEO.features)) ? LOC_GEO.features : [];
    return feats.map(f=>f.properties||{});
  }

  function buildEntidadFromFuente(){
    const rows = (fuenteCombos()||[]).filter(r=> num(r[QUIERE_COL] ?? r.quiere_estufa) > 0);
    const ents = uniqSorted(rows.map(r=> r.ENTIDAD || r.entidad));
    setOptions('#f_entidad', ents, 'Todas');
  }
  function cascadeMunicipios(){
    const ent = $('#f_entidad').value;
    const rows = (fuenteCombos()||[]).filter(r=>{
      const okE=!ent || normaliza(r.ENTIDAD||r.entidad)===normaliza(ent);
      return okE && num(r[QUIERE_COL] ?? r.quiere_estufa) > 0;
    });
    const muns = uniqSorted(rows.map(r=> r.MUNICIPIO || r.municipio));
    setOptions('#f_municipio', muns, 'Todos');
  }
  function cascadeLocalidades(){
    const ent=$('#f_entidad').value, mun=$('#f_municipio').value;
    const rows = (fuenteCombos()||[]).filter(r=>{
      const okE=!ent || normaliza(r.ENTIDAD||r.entidad)===normaliza(ent);
      const okM=!mun || normaliza(r.MUNICIPIO||r.municipio)===normaliza(mun);
      return okE && okM && num(r[QUIERE_COL] ?? r.quiere_estufa) > 0;
    });
    const locs = uniqSorted(rows.map(r=> r.LOCALIDAD || r.localidad || r.NOM_LOC));
    setOptions('#f_localidad', locs, 'Todas');
  }

  function bootstrapFiltersSimple(){ setOptions('#f_modelo', MODELOS, 'Todos'); }

  function getFilters(){
    return{
      modelo:$('#f_modelo').value,
      entidad:$('#f_entidad').value,
      municipio:$('#f_municipio').value,
      localidad:$('#f_localidad').value,
      estatus:$('#f_estatus').value,
      week:$('#f_week').value
    }
  }

  /* =================== Carga CSV para filtros y KPI =================== */
  function cargarCensoCSV_yCombos(){
    Papa.parse('Censo_estufas.csv', {
      download:true, header:true, skipEmptyLines:true,
      complete:(res)=>{
        CENSO_ROWS = (res.data||[]).map(r=>{
          const ENT = r.ENTIDAD || r.entidad || r['Entidad'] || '';
          const MUN = r.MUNICIPIO || r.municipio || r['Municipio'] || '';
          const LOC = r.LOCALIDAD || r.localidad || r['Localidad'] || r.NOM_LOC || '';
          return { ENTIDAD: ENT, MUNICIPIO: MUN, LOCALIDAD: LOC, ...r };
        });
        CSV_LOC_SET = new Set(CENSO_ROWS.map(r => `${normaliza(r.ENTIDAD)}|${normaliza(r.MUNICIPIO)}|${normaliza(r.LOCALIDAD)}`));

        buildEntidadFromFuente();
        cascadeMunicipios();
        cascadeLocalidades();
        renderKPIQuiereEstufa();

        csvReady = true;
        tryRegenerateSynthetic();
      },
      error:(e)=>{ console.warn('No se pudo leer Censo_estufas.csv', e); }
    });
  }

  /* =================== Semana ISO y helpers =================== */
  function isoWeekKey(dateStr){
    const d=new Date(dateStr);
    const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day+3);
    const firstThursday=new Date(d.getFullYear(),0,4);
    const diff=d-firstThursday; const week=1+Math.round(diff/604800000);
    const y=d.getFullYear(); return `${y}-W${String(week).padStart(2,'0')}`;
  }
  function sortWeekKeys(a,b){const [ya,wa]=a.split('-W').map(Number);const [yb,wb]=b.split('-W').map(Number);return ya===yb?wa-wb:ya-yb;}

  function buildWeightedWeeks(){
    const start = new Date(START_DATE);
    start.setDate(start.getDate() - ((start.getDay()+6)%7));
    const weeks = [];
    while (start <= END_DATE){
      weeks.push(new Date(start));
      start.setDate(start.getDate()+7);
    }
    const weights = weeks.map((_,i)=> Math.max(1, Math.round(1 + Math.abs(Math.sin(i*0.9))*6 + Math.random()*2)));
    return {weeks, weights};
  }
  function pickWeighted(arr, weights){
    const sum = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*sum;
    for(let i=0;i<arr.length;i++){ if((r-=weights[i])<0) return i; }
    return arr.length-1;
  }
  function randomDateWeighted(){
    const {weeks, weights} = buildWeightedWeeks();
    const idx = pickWeighted(weeks, weights);
    const d = new Date(weeks[idx]);
    d.setDate(d.getDate() + Math.floor(Math.random()*7));
    if (d < START_DATE) return new Date(START_DATE);
    if (d > END_DATE)   return new Date(END_DATE);
    return d;
  }
  function jitter(val, span){ return val + (Math.random()-0.5)*span; }

  /* =================== Generación POR MUNICIPIO =================== */
  function municipiosDesdeCensoFiltrado(){
    const f=getFilters();
    let rows = CENSO_ROWS;
    if (!rows.length && LOC_GEO){ rows = (LOC_GEO.features||[]).map(ft=>ft.properties||{}); }
    let lista = [];
    rows.forEach(r=>{
      const ent = r.ENTIDAD || r.entidad;
      const mun = r.MUNICIPIO || r.municipio;
      if (!eqN(ent,f.entidad)) return;
      if (!eqN(mun,f.municipio)) return;
      if (num(r[QUIERE_COL] ?? r.quiere_estufa) <= 0) return;
      lista.push(`${ent}|||${mun}`);
    });
    lista = [...new Set(lista)];
    if (!f.municipio && lista.length > 50){ lista = lista.slice(0, 50); }
    return lista.map(s=>{ const [ent,mun]=s.split('|||'); return {ent,mun}; });
  }

  function pickLocalidadPoint(ent, mun, locFilter){
    if(!LOC_GEO) return {lat:19.7, lng:-101.9, nombre: mun};
    const feats = (LOC_GEO.features||[]).filter(ft=>{
      const p=ft.properties||{};
      const okE = eqN(gProp(p,'ENTIDAD','entidad'), ent);
      const okM = eqN(gProp(p,'MUNICIPIO','municipio'), mun);
      const okL = !locFilter || eqN(gProp(p,'LOCALIDAD','localidad','NOM_LOC'), locFilter);
      return okE && okM && okL && ft.geometry && ft.geometry.type==='Point';
    });
    if(feats.length===0){
      const any = (LOC_GEO.features||[]).filter(ft=>{
        const p=ft.properties||{};
        return eqN(gProp(p,'ENTIDAD','entidad'), ent) && eqN(gProp(p,'MUNICIPIO','municipio'), mun) && ft.geometry && ft.geometry.type==='Point';
      });
      if(any.length){
        const r = any[Math.floor(Math.random()*any.length)];
        return {lat: r.geometry.coordinates[1], lng: r.geometry.coordinates[0], nombre: gProp(r.properties,'LOCALIDAD','localidad','NOM_LOC') || mun};
      }
      return {lat:19.7, lng:-101.9, nombre: mun};
    }
    const pick = feats[Math.floor(Math.random()*feats.length)];
    return {lat: pick.geometry.coordinates[1], lng: pick.geometry.coordinates[0], nombre: gProp(pick.properties,'LOCALIDAD','localidad','NOM_LOC') || mun};
  }

  function regenerateSyntheticByMunicipio(){
    SYNTH = [];
    const f=getFilters();
    const pairs = municipiosDesdeCensoFiltrado();
    let seq = 1;

    pairs.forEach(({ent,mun})=>{
      const locChoice = pickLocalidadPoint(ent, mun, f.localidad);
      for(let i=0;i<EJEMPLOS_POR_MUNICIPIO;i++){
        const fecha = randomDateWeighted();
        const modelo = MODELOS[Math.floor(Math.random()*MODELOS.length)];
        const programa = PROGRAMAS[Math.floor(Math.random()*PROGRAMAS.length)];
        const consumo_base = 90 + Math.floor(Math.random()*60);
        const ahorro = 30 + Math.floor(Math.random()*40);
        const consumo_post = Math.max(10, consumo_base - ahorro);

        SYNTH.push({
          id: `${normaliza(mun)}-${String(seq++).padStart(5,'0')}`,
          programa, proveedor:'Proveedor Demo',
          modelo, entidad: ent, municipio: mun, localidad: locChoice.nombre,
          lat: jitter(locChoice.lat, 0.01),
          lng: jitter(locChoice.lng, 0.01),
          estatus:'Instalada',
          fecha_instalacion: fecha.toISOString().slice(0,10),
          garantia_fin:'2027-12-31',
          visita_ult_fecha: fecha.toISOString().slice(0,10),
          visita_ult_hallazgo:'OK',
          consumo_base, consumo_post
        });
      }
    });
  }

  function tryRegenerateSynthetic(){
    if (!csvReady || !geoReady) return;
    regenerateSyntheticByMunicipio();
    buildWeeksFromData();
    renderAll();
  }

  /* =================== Aplicación de filtros =================== */
  function getAllRows(){ return DATA.concat(SYNTH); }

  function applyFilters(data){
    const f=getFilters();
    return data.filter(d=>
      (!f.modelo   || d.modelo===f.modelo) &&
      (eqN(d.entidad, f.entidad)) &&
      (eqN(d.municipio, f.municipio)) &&
      (eqN(d.localidad, f.localidad)) &&
      (!f.estatus  || d.estatus===f.estatus) &&
      (!f.week     || isoWeekKey(d.fecha_instalacion)===f.week)
    );
  }

  function renderKPIs(rows){
    const total=rows.length;
    const seg=rows.filter(r=>r.estatus==='En seguimiento').length;

    const elE = document.getElementById('k_estufas'); if (elE) elE.textContent = fmt(total);
    const pobl = Math.round(total * 4.2);
    const elP = document.getElementById('k_poblacion'); if (elP) elP.textContent = fmt(pobl);
    const elS = document.getElementById('k_seguimiento'); if (elS) elS.textContent = seg + " (" + (total ? Math.round(seg/total*100) : 0) + "%)";
  }

  function renderKPIQuiereEstufa(){
    const f = getFilters();
    let totalQuiere = 0;
    if (CENSO_ROWS.length){
      CENSO_ROWS.forEach(r=>{
        const okE = eqN(r.ENTIDAD,f.entidad);
        const okM = eqN(r.MUNICIPIO,f.municipio);
        const okL = eqN(r.LOCALIDAD,f.localidad);
        if (okE && okM && okL) totalQuiere += num(r[QUIERE_COL]);
      });
    } else if (LOC_GEO) {
      const feats = (LOC_GEO.features||[]);
      feats.forEach(({properties:p={}})=>{
        const ent=gProp(p,'ENTIDAD','entidad');
        const mun=gProp(p,'MUNICIPIO','municipio');
        const loc=gProp(p,'LOCALIDAD','localidad','NOM_LOC');
        const okE=eqN(ent,f.entidad);
        const okM=eqN(mun,f.municipio);
        const okL=eqN(loc,f.localidad);
        if (okE && okM && okL) totalQuiere += num(p.quiere_estufa);
      });
    }
    const elQ = document.getElementById('k_quiere_estufa'); if (elQ) elQ.textContent = fmt(totalQuiere);
  }

  /* ===================== MAPA ===================== */
  let map, muniLayer, locaAllLayer, layerControl, estufasLayer;

  function colorByRatio(ratio){
    return ratio > 0.95 ? '#bd0026' :
           ratio > 0.90 ? '#9F2241' :
           ratio > 0.85 ? '#fd8d3c' :
           ratio > 0.80 ? '#feb24c' : '#fed976';
  }

  function loadMunicipios(){
    fetch('estufas_municipios.geojson')
      .then(r => r.json())
      .then(geo => {
        muniLayer = L.geoJSON(geo, {
          style: f => {
            const p = f.properties || {};
            const ratio = (p.quiere_estufa && p.hogares) ? (p.quiere_estufa / p.hogares) : 0;
            return { color:getCss('--azul'), weight:1, fillOpacity:0.6, fillColor:colorByRatio(ratio) };
          },
          onEachFeature: (feature, lyr) => {
            const p = feature.properties || {};
            const pct = (p.hogares && p.quiere_estufa) ? ((p.quiere_estufa/p.hogares)*100).toFixed(1) : '0.0';
            lyr.bindPopup(
              `<b>${p.MUNICIPIO||p.municipio||'—'}, ${p.ENTIDAD||p.entidad||'—'}</b><br>
               Hogares: ${Number(p.hogares||0).toLocaleString('es-MX')}<br>
               Quiere estufa: ${Number(p.quiere_estufa||0).toLocaleString('es-MX')} (${pct}%)`
            );
          }
        });

        muniLayer.addTo(map);
        if (!window.__fittedMunicipios && muniLayer.getLayers().length){
          try{ map.fitBounds(muniLayer.getBounds(), { padding:[20,20] }); window.__fittedMunicipios = true; }catch(e){}
        }
        if(layerControl && !window._addedMunicipios){
          layerControl.addOverlay(muniLayer, 'Municipios');
          window._addedMunicipios = true;
        }
      })
      .catch(err => console.error('No se pudo cargar estufas_municipios.geojson', err));
  }

  async function fetchFirstExisting(paths){
    for (const p of paths){
      try{ const r = await fetch(p,{cache:'no-store'}); if(r.ok){ return r.json(); } }catch(e){}
    }
    throw new Error('No se encontró el GeoJSON de localidades.');
  }

  function crearCapaLocalidades(){
    if(!LOC_GEO) return;
    locaAllLayer = L.geoJSON(LOC_GEO, {
      filter: (feature)=>{
        if(!CSV_LOC_SET) return true;
        const p = feature.properties||{};
        const ent = gProp(p,'ENTIDAD','entidad');
        const mun = gProp(p,'MUNICIPIO','municipio');
        const loc = gProp(p,'LOCALIDAD','localidad','NOM_LOC');
        return CSV_LOC_SET.has(`${normaliza(ent)}|${normaliza(mun)}|${normaliza(loc)}`);
      },
      pointToLayer: (feature, latlng) => {
        const p=feature.properties||{};
        const ratio = (p.quiere_estufa && p.hogares) ? (p.quiere_estufa/p.hogares) : 0;
        return L.circleMarker(latlng,{radius:6,color:'#fff',weight:1,fillColor:colorByRatio(ratio),fillOpacity:.9});
      }
    });
    if(layerControl && !window._addedLocalidades){
      layerControl.addOverlay(locaAllLayer,'Localidades');
      window._addedLocalidades = true;
    }
  }

  async function loadLocalidades(){
    try{
      const geo = await fetchFirstExisting([
        'localidades_filtradas_mich.geojson',
        'localidades_filtrdas_mich.geojson',
        './localidades_filtradas_mich.geojson',
        './localidades_filtrdas_mich.geojson'
      ]);
      LOC_GEO = geo;
      crearCapaLocalidades();

      if(!(CENSO_ROWS && CENSO_ROWS.length)){
        buildEntidadFromFuente(); cascadeMunicipios(); cascadeLocalidades();
      }

      geoReady = true;
      tryRegenerateSynthetic();
    }catch(err){
      console.error(err);
      alert('No se pudo cargar la capa de Localidades.\nVerifica nombre/ubicación del archivo.');
    }
  }

  function renderMap(rows){
    if(!map){
      map = L.map('map').setView([22.5,-102],5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'© OpenStreetMap'}).addTo(map);
      layerControl = L.control.layers(null, {}, {collapsed:false}).addTo(map);

      estufasLayer = L.layerGroup().addTo(map);
      layerControl.addOverlay(estufasLayer, 'Estufas');

      loadMunicipios();
      loadLocalidades();
    }

    estufasLayer.clearLayers();
    rows.forEach(r=>{
      const color = r.estatus==='Instalada'     ? getCss('--guinda') :
                    r.estatus==='En seguimiento'? getCss('--dorado') :
                    r.estatus==='Garantía'      ? getCss('--verde')  : '#d62728';
      const icon=L.divIcon({html:`<div style="width:14px;height:14px;border-radius:50%;background:${color};border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.2)"></div>`});
      L.marker([r.lat,r.lng],{icon}).addTo(estufasLayer)
        .bindPopup(`<b>${r.programa}</b><br/>${r.modelo} · ${r.estatus}<br/>${(r.localidad? r.localidad+', ' : '') + (r.municipio||'')}, ${r.entidad}<br/>Instalada: ${new Date(r.fecha_instalacion).toLocaleDateString('es-MX')}`);
    });

    try{
      if(rows.length){
        const g = L.featureGroup(estufasLayer.getLayers());
        map.fitBounds(g.getBounds(),{padding:[20,20], maxZoom:12});
      }
    }catch(e){}
  }

  /* ===================== GRÁFICAS ===================== */
  let chart1, chart2;
  Chart.defaults.color = getCss('--azul');
  Chart.defaults.font.family = 'Noto Sans, Arial, sans-serif';
  Chart.defaults.font.size = 12;

  function renderCharts(rows){
    const byWeek={};
    rows.forEach(r=>{const wk=isoWeekKey(r.fecha_instalacion); byWeek[wk]=(byWeek[wk]||0)+1;});
    const labels=Object.keys(byWeek).sort(sortWeekKeys);
    const counts=labels.map(k=>byWeek[k]);

    const weekSel=$('#f_week');
    if(weekSel && weekSel.options.length<=1){ labels.forEach(l=>{const op=document.createElement('option');op.value=op.textContent=l;weekSel.appendChild(op);}); }

    const cfg1={type:'bar',data:{labels,datasets:[{label:'Instalaciones',data:counts,backgroundColor:getCss('--guinda')}]},options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}};
    if(!chart1){ chart1=new Chart($('#chartInstalaciones'),cfg1);} else { chart1.data.labels=labels; chart1.data.datasets[0].data=counts; chart1.update(); }

    const byModel={}; rows.forEach(r=>{const ah=Math.max(0,r.consumo_base-r.consumo_post); if(!byModel[r.modelo]) byModel[r.modelo]={s:0,c:0}; byModel[r.modelo].s+=ah; byModel[r.modelo].c++;});
    const ml=Object.keys(byModel).sort(); const av=ml.map(m=>(byModel[m].s/byModel[m].c).toFixed(1));
    const cfg2={type:'bar',data:{labels:ml,datasets:[{label:'Ahorro promedio (kg/mes)',data:av,backgroundColor:getCss('--dorado')}]},options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}};
    if(!chart2){ chart2=new Chart($('#chartAhorro'),cfg2);} else { chart2.data.labels=ml; chart2.data.datasets[0].data=av; chart2.update(); }
  }

  /* ===================== Bitácora / Tablas ===================== */
  let dtBitacora;
  const BITACORA_DATA = [
    {"fecha":"2025-07-28","entidad":"Michoacán","municipio":"Charapan","localidad":"Ocumicho","beneficiario":"María Pérez","estatus":"Instalación","espacio_listo":"Sí","materiales":"Entregados","fecha_inicio":"2025-07-29","funcion":"OK","piezas":"Completas","satisfaccion":"Alta","observaciones":"Sin novedad"},
    {"fecha":"2025-07-28","entidad":"Michoacán","municipio":"Charapan","localidad":"Cocucho","beneficiario":"Juan López","estatus":"Capacitación","espacio_listo":"Sí","materiales":"Pendientes","fecha_inicio":"2025-07-30","funcion":"OK","piezas":"Completas","satisfaccion":"Alta","observaciones":"Falta entregar accesorios"},
    {"fecha":"2025-07-30","entidad":"Michoacán","municipio":"Charapan","localidad":"San Felipe","beneficiario":"Rosa García","estatus":"Seguimiento","espacio_listo":"Sí","materiales":"Entregados","fecha_inicio":"2025-07-31","funcion":"OK","piezas":"Completas","satisfaccion":"Media","observaciones":"Humo mínimo en arranque"},
    {"fecha":"2025-08-02","entidad":"Michoacán","municipio":"Charapan","localidad":"Ocumicho","beneficiario":"Pedro Hernández","estatus":"Instalación","espacio_listo":"Sí","materiales":"Entregados","fecha_inicio":"2025-08-03","funcion":"OK","piezas":"Completas","satisfaccion":"Alta","observaciones":"Capacitación concluida"},
    {"fecha":"2025-08-02","entidad":"Michoacán","municipio":"Paracho","localidad":"Aranza","beneficiario":"Lucía Martínez","estatus":"Instalación","espacio_listo":"No","materiales":"Parcial","fecha_inicio":"2025-08-05","funcion":"N/A","piezas":"Incompletas","satisfaccion":"N/A","observaciones":"Adecuar salida de humo"},
    {"fecha":"2025-08-03","entidad":"Michoacán","municipio":"Paracho","localidad":"Cherán","beneficiario":"Miguel Torres","estatus":"Capacitación","espacio_listo":"Sí","materiales":"Entregados","fecha_inicio":"2025-08-04","funcion":"OK","piezas":"Completas","satisfaccion":"Alta","observaciones":"Se entregó tríptico"},
    {"fecha":"2025-08-04","entidad":"Michoacán","municipio":"Charapan","localidad":"Cocucho","beneficiario":"Ana López","estatus":"Seguimiento","espacio_listo":"Sí","materiales":"Entregados","fecha_inicio":"2025-08-04","funcion":"OK","piezas":"Completas","satisfaccion":"Alta","observaciones":"Ajuste de campana"},
    {"fecha":"2025-08-05","entidad":"Michoacán","municipio":"Charapan","localidad":"Ocumicho","beneficiario":"José Ramírez","estatus":"Instalación","espacio_listo":"Sí","materiales":"Entregados","fecha_inicio":"2025-08-05","funcion":"OK","piezas":"Completas","satisfaccion":"Alta","observaciones":"Listo para entrega final"}
  ];

  function initBitacoraEjemplo(){
    const el = document.getElementById('tablaBitacora');
    if(!el) return;

    const dtLang = {
      decimal: ",", thousands: ".",
      info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
      infoEmpty: "Mostrando 0 a 0 de 0 registros",
      infoFiltered: "(filtrado de _MAX_ en total)",
      lengthMenu: "Mostrar _MENU_",
      loadingRecords: "Cargando...",
      processing: "Procesando...",
      search: "Buscar:",
      zeroRecords: "No se encontraron registros",
      paginate: { first: "Primera", last: "Última", next: "Siguiente", previous: "Anterior" }
    };

    if (dtBitacora) {
      dtBitacora.clear();
      dtBitacora.rows.add(BITACORA_DATA).draw();
    } else {
      dtBitacora = new DataTable('#tablaBitacora', {
        data: BITACORA_DATA,
        columns: [
          { title: 'Fecha', data: 'fecha' },
          { title: 'Entidad', data: 'entidad' },
          { title: 'Municipio', data: 'municipio' },
          { title: 'Localidad', data: 'localidad' },
          { title: 'Beneficiario / Hogar', data: 'beneficiario' },
          { title: 'Estatus', data: 'estatus' },
          { title: 'Espacio listo', data: 'espacio_listo' },
          { title: 'Materiales entregados', data: 'materiales' },
          { title: 'Fecha inicio obra', data: 'fecha_inicio' },
          { title: 'Funcionamiento', data: 'funcion' },
          { title: 'Checklist piezas', data: 'piezas' },
          { title: 'Satisfacción', data: 'satisfaccion' },
          { title: 'Observaciones', data: 'observaciones' }
        ],
        pageLength: 8,
        responsive: true,
        language: dtLang,
        dom: 'ftip'
      });
    }
  }

  /* ===================== Tablas Censo ===================== */
  let rowsLocalidadesAll = [];
  let dtLocalidades = null;

  function initTablasCenso(){
    const dtLang = {
      decimal: ",", thousands: ".",
      info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
      infoEmpty: "Mostrando 0 a 0 de 0 registros",
      infoFiltered: "(filtrado de _MAX_ en total)",
      lengthMenu: "Mostrar _MENU_",
      loadingRecords: "Cargando...",
      processing: "Procesando...",
      search: "Buscar:",
      zeroRecords: "No se encontraron registros",
      paginate: { first: "Primera", last: "Última", next: "Siguiente", previous: "Anterior" }
    };

    fetch('estufas_agg_localidad_detalle.json')
      .then(r => r.json())
      .then(rows => {
        rows.forEach(r => { r.porc_quiere = (Number(r.porc_quiere||0)*100).toFixed(1); });
        rowsLocalidadesAll = rows;
        renderTablaLocalidades();
      });

    fetch('ranking_priorizacion_municipio.json')
      .then(r => r.json())
      .then(rows => {
        const installedByMun = {};
        getAllRows().forEach(d=>{ if(d.estatus==='Instalada'){ installedByMun[d.municipio] = (installedByMun[d.municipio]||0) + 1; }});
        rows.forEach(r=>{
          const instaladas = installedByMun[r.MUNICIPIO] || 0;
          r.instaladas = instaladas;
          const quiere = Number(r.quiere_estufa||0);
          r.pct_q_sobre_inst = quiere > 0 ? (instaladas / quiere) * 100 : 0;
        });
        new DataTable('#tablaRanking', {
          data: rows,
          columns: [
            { title: 'Entidad', data: 'ENTIDAD' },
            { title: 'Municipio', data: 'MUNICIPIO' },
            { title: 'Hogares', data: 'hogares', render: d => Number(d||0).toLocaleString('es-MX') },
            { title: 'Población Objetivo', data: 'quiere_estufa', render: d => Number(d||0).toLocaleString('es-MX') },
            { title: 'Estufas construidas', data: 'instaladas', render: d => Number(d||0).toLocaleString('es-MX') },
            { title: '% Estufas instaladas', data: 'pct_q_sobre_inst', render: d => `${Number(d||0).toFixed(1)}%` }
          ],
          order: [[5,'desc']],
          pageLength: 8, responsive: true, language: dtLang, dom: 'ftip', lengthChange: false
        });
      });
  }

  function filasLocalidadesFiltradas(){
    const f=getFilters();
    return rowsLocalidadesAll.filter(r=>{
      const okE = eqN(r.ENTIDAD, f.entidad);
      const okM = eqN(r.MUNICIPIO, f.municipio);
      const okL = eqN(r.LOCALIDAD, f.localidad);
      return okE && okM && okL;
    });
  }

  function renderTablaLocalidades(){
    const data = filasLocalidadesFiltradas();
    const cfg = {
      data,
      columns: [
        { title: 'Entidad', data: 'ENTIDAD' },
        { title: 'Municipio', data: 'MUNICIPIO' },
        { title: 'Localidad', data: 'LOCALIDAD' },
        { title: 'Hogares', data: 'hogares', render: d => Number(d||0).toLocaleString('es-MX') },
        { title: 'Población Objetivo', data: 'quiere_estufa', render: d => Number(d||0).toLocaleString('es-MX') },
        { title: '% Población que requiere estufa', data: 'porc_quiere', render: d => `${Number(d||0).toFixed(1)}%` }
      ],
      pageLength: 10, responsive: true, language: {
        decimal: ",", thousands: ".",
        info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
        infoEmpty: "Mostrando 0 a 0 de 0 registros",
        infoFiltered: "(filtrado de _MAX_ en total)",
        lengthMenu: "Mostrar _MENU_",
        loadingRecords: "Cargando...",
        processing: "Procesando...",
        search: "Buscar:",
        zeroRecords: "No se encontraron registros",
        paginate: { first: "Primera", last: "Última", next: "Siguiente", previous: "Anterior" }
      },
      dom: 'ftip'
    };
    if(dtLocalidades){
      dtLocalidades.clear();
      dtLocalidades.rows.add(data).draw();
    }else{
      dtLocalidades = new DataTable('#tablaLocalidades', cfg);
    }
  }

  /* ===================== Tabla simple (legacy) ===================== */
  let dt;
  function renderTable(rows){
    const data=rows.map(r=>({
      id:r.id,programa:r.programa,proveedor:r.proveedor,modelo:r.modelo,entidad:r.entidad,municipio:r.municipio,localidad:r.localidad,estatus:r.estatus,
      fecha_instalacion:new Date(r.fecha_instalacion).toLocaleDateString('es-MX'),
      garantia_fin:new Date(r.garantia_fin).toLocaleDateString('es-MX'),
      visita_ult_fecha:new Date(r.visita_ult_fecha).toLocaleDateString('es-MX'),
      ahorro:Math.max(0,r.consumo_base-r.consumo_post)
    }));
    if(dt){ dt.clear(); dt.rows.add(data).draw(); }
  }

  /* ===================== REFRESH GENERAL ===================== */
  function renderAll(){
    const rows=applyFilters(DATA.concat(SYNTH));
    renderKPIs(rows);
    renderMap(rows);
    renderCharts(rows);
    renderTable(rows);
    renderKPIQuiereEstufa();
  }

  function buildWeeksFromData(){
    const weeks=[...new Set(DATA.concat(SYNTH).map(d=>isoWeekKey(d.fecha_instalacion)))].sort(sortWeekKeys);
    if($('#f_week') && $('#f_week').options.length<=1){
      weeks.forEach(w=>{const op=document.createElement('option');op.value=op.textContent=w;$('#f_week').appendChild(op);});
    }
  }

  /* ===================== INIT ===================== */
  bootstrapFiltersSimple();
  buildWeeksFromData();
  renderAll();
  initTablasCenso();
  cargarCensoCSV_yCombos();
  initBitacoraEjemplo();

  // Listeners filtros/cascadas + regeneración sintética
  $('#f_entidad').addEventListener('change',()=>{ cascadeMunicipios(); cascadeLocalidades(); regenerateSyntheticByMunicipio(); renderAll(); renderTablaLocalidades(); });
  $('#f_municipio').addEventListener('change',()=>{ cascadeLocalidades(); regenerateSyntheticByMunicipio(); renderAll(); renderTablaLocalidades(); });
  $('#f_localidad').addEventListener('change',()=>{ regenerateSyntheticByMunicipio(); renderAll(); renderTablaLocalidades(); });
  ['#f_modelo','#f_estatus','#f_week'].forEach(s=>$(s).addEventListener('change',()=>{ renderAll(); }));

  // Leyenda
  (function addLegend(){
    if(!window.L) return;
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'info legend');
      div.style.background = '#fff';
      div.style.padding = '8px 10px';
      div.style.border = '1px solid var(--borde)';
      div.style.borderRadius = '8px';
      div.innerHTML = '<b>Solicitud de estufas</b><br>'
        + '<span style="display:inline-block;width:12px;height:12px;background:#fed976;margin-right:6px;border:1px solid #ccc"></span> ≤ 80%<br>'
        + '<span style="display:inline-block;width:12px;height:12px;background:#feb24c;margin-right:6px;border:1px solid #ccc"></span> 80–85%<br>'
        + '<span style="display:inline-block;width:12px;height:12px;background:#fd8d3c;margin-right:6px;border:1px solid #ccc"></span> 85–90%<br>'
        + '<span style="display:inline-block;width:12px;height:12px;background:#9F2241;margin-right:6px;border:1px solid #ccc"></span> 90–95%<br>'
        + '<span style="display:inline-block;width:12px;height:12px;background:#bd0026;margin-right:6px;border:1px solid #ccc"></span> > 95%';
      return div;
    };
    setTimeout(()=>legend.addTo(map),1000);
  })();

  // Cargar geo
  loadLocalidades();

  // Lightbox
  const lightboxEl = document.createElement('div');
  lightboxEl.className = 'lightbox';
  lightboxEl.innerHTML = `<button class="close" aria-label="Cerrar" title="Cerrar (Esc)">&times;</button><img alt="">`;
  document.body.appendChild(lightboxEl);
  function openLightbox(src,alt){ const img=lightboxEl.querySelector('img'); img.src=src; img.alt=alt||''; lightboxEl.classList.add('open'); }
  lightboxEl.addEventListener('click',e=>{ if(e.target===lightboxEl || e.target.classList.contains('close')) lightboxEl.classList.remove('open'); });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') lightboxEl.classList.remove('open'); });


  /* ===================== DONUT META NACIONAL ===================== */
  <script>
  /* ===================== DONUT META NACIONAL ===================== */
  const META_NAC = 1000000;

  const ESTADOS = [
    { key:'mich', nombre:'Michoacán',      color:'#0c2f29', meta:17582,  built:0 },
    { key:'slp',  nombre:'San Luis Potosí',color:'#b57c42', meta:12000,  built:0 },
    { key:'oax',  nombre:'Oaxaca',         color:'#90ab84', meta:250000, built:0 },
    { key:'gro',  nombre:'Guerrero',       color:'#7d7f7f', meta:180000, built:0 },
    { key:'chi',  nombre:'Chiapas',        color:'#3a5f4a', meta:350000, built:0 }
  ];
  const COLOR_OTROS = '#e0e0e3';

  let donutChart = null;
  let donutCenter = { value: META_NAC, label: 'Meta nacional' };
  let selectedIndex = -1; // índice del dataset (sin contar "otros" será 0..4)

  // ===== Texto grande al centro (formato anterior) =====
  const centerText = {
    id: 'centerText',
    afterDraw(chart){
      const {ctx, chartArea:{width,height}} = chart;
      ctx.save();
      ctx.textAlign='center';
      ctx.fillStyle='#111';
      ctx.font='700 26px Noto Sans, Arial';
      ctx.fillText((donutCenter.value||0).toLocaleString('es-MX'), width/2, height/2 - 6);
      ctx.font='400 12px Noto Sans, Arial';
      ctx.fillText(donutCenter.label, width/2, height/2 + 16);
      ctx.restore();
    }
  };

  function getBuiltFor(entidadNombre){
    return getAllRows().filter(r => (r.entidad||'').toLowerCase() === entidadNombre.toLowerCase() && r.estatus==='Instalada').length;
  }

  // Vincula Michoacán a lo que muestre el KPI “Estufas instaladas”
  function linkMichoacanToKPI(){
    const k = Number(String(document.getElementById('k_estufas')?.textContent||'').replace(/[^\d]/g,''));
    const mich = ESTADOS.find(e=>e.key==='mich');
    if(mich && k>0){ mich.meta = k; }
  }

  function refreshBuiltValues(){
    ESTADOS.forEach(e=>{
      e.built = (e.nombre==='Michoacán') ? getBuiltFor('Michoacán') : 0;
    });
  }

  function otrosValor(){
    const sumaSel = ESTADOS.reduce((a,e)=>a+e.meta,0);
    return Math.max(0, META_NAC - sumaSel);
  }

  // Leyenda lateral
  function buildStateList(){
    const UL = document.getElementById('stateList');
    UL.innerHTML = '';
    ESTADOS.forEach((e,i)=>{
      const li = document.createElement('li');
      li.dataset.index = i;
      li.innerHTML = `
        <div class="state-left">
          <span class="dot" style="background:${e.color}"></span>
          <span>${e.nombre}</span>
        </div>
        <strong>${Number(e.meta||0).toLocaleString('es-MX')}</strong>
      `;
      li.addEventListener('click', ()=> handleSliceClick(i));
      UL.appendChild(li);
    });
  }

  // Mini panel (sin NaN cuando no hay selección)
  function setMini(meta,built){
    const $m = id => document.getElementById(id);
    if(meta==null || isNaN(Number(meta))){
      $m('miniMeta').textContent = '—';
      $m('miniBuilt').textContent = '—';
      $m('miniMissing').textContent = '—';
      $m('miniPct').textContent = '—';
      return;
    }
    meta  = Number(meta);
    built = Number(built||0);
    $m('miniMeta').textContent    = meta.toLocaleString('es-MX');
    $m('miniBuilt').textContent   = built.toLocaleString('es-MX');
    const missing = Math.max(0, meta - built);
    $m('miniMissing').textContent = missing.toLocaleString('es-MX');
    const pct = meta>0 ? ((built/meta)*100).toFixed(1)+'%' : '—';
    $m('miniPct').textContent = pct;
  }

  // Distribución/orden como en la imagen: arrancar "Otros" arriba (12 en punto)
  function datasetOrdenado(){
    const otros = otrosValor();
    // Orden en el pastel: Otros, Oaxaca, Guerrero, Chiapas, Michoacán, SLP
    const orderKeys = ['OTROS','oax','gro','chi','mich','slp'];
    const data=[], colors=[], labels=[];
    orderKeys.forEach(k=>{
      if(k==='OTROS'){ data.push(otros); colors.push(COLOR_OTROS); labels.push('Otros'); }
      else{
        const e = ESTADOS.find(x=>x.key===k);
        data.push(e.meta); colors.push(e.color); labels.push(e.nombre);
      }
    });
    return {data, colors, labels};
  }

  function drawDonut(){
    const ctx = document.getElementById('pastelMeta').getContext('2d');
    const pack = datasetOrdenado();

    donutChart = new Chart(ctx, {
      type:'doughnut',
      data:{
        labels: pack.labels,
        datasets:[{
          data: pack.data,
          backgroundColor: pack.colors,
          borderWidth: 0,
          borderRadius: 8,      // bordes redondeados (estilo anterior)
          hoverOffset: 8,
          offset: new Array(pack.data.length).fill(0)
        }]
      },
      options:{
        maintainAspectRatio:false,
        cutout:'70%',           // aro grueso como el anterior
        rotation: -Math.PI/2,   // inicia arriba (12 en punto)
        plugins:{ legend:{ display:false },
                  tooltip:{ callbacks:{ label:(ctx)=> `${ctx.label}: ${Number(ctx.parsed||0).toLocaleString('es-MX')}` } } }
      },
      plugins:[centerText]
    });

    // Click en el pastel
    document.getElementById('pastelMeta').onclick = (evt)=>{
      const el = donutChart.getElementsAtEventForMode(evt,'nearest',{intersect:true},true);
      if(!el.length){ resetSelection(); return; }
      const idx = el[0].index;        // 0 es "Otros"
      if(idx===0){ resetSelection(); return; } // clic en otros -> reset
      handleSliceClick(idx-1);        // mapeamos 1..5 => 0..4 de ESTADOS
    };
  }

  function handleSliceClick(estadoIndex){
    selectedIndex = estadoIndex;              // 0..4 en ESTADOS
    const e = ESTADOS[selectedIndex];

    // Centro: resto nacional una vez descontada la meta del estado
    donutCenter.value = Math.max(0, META_NAC - Number(e.meta||0));
    donutCenter.label = 'Resto nacional';

    // offsets (resalta la rebanada seleccionada)
    const offs = new Array(ESTADOS.length+1).fill(0);
    offs[selectedIndex+1] = 14; // +1 porque 0 es "Otros"
    donutChart.data.datasets[0].offset = offs;

    // mini panel
    setMini(e.meta, e.built);

    // estado activo en lista
    document.querySelectorAll('#stateList li').forEach(li=>{
      li.classList.toggle('active', Number(li.dataset.index)===selectedIndex);
    });

    donutChart.update();
  }

  function resetSelection(){
    selectedIndex = -1;
    donutCenter.value = META_NAC;
    donutCenter.label = 'Meta nacional';
    donutChart.data.datasets[0].offset = new Array(ESTADOS.length+1).fill(0);
    setMini(null,null);
    document.querySelectorAll('#stateList li').forEach(li=>li.classList.remove('active'));
    donutChart.update();
  }

  function initDonut(){
    linkMichoacanToKPI();
    refreshBuiltValues();
    buildStateList();
    drawDonut();
    resetSelection();
  }

  // Inicializar donut
  initDonut();
</script>
</body>
</html>
